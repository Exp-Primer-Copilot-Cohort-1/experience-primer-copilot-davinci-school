<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird - Three.js</title>
    <style>
        /* Reset základních stylů pro konzistenci mezi prohlížeči */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            /* Halloween fialové pozadí (gradient) */
            background: linear-gradient(135deg, #2b0036 0%, #6a00a4 50%, #a14fe0 100%);
        }

        /* Kontejner pro canvas Three.js */
        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* HUD overlay pro skóre */
        #hud {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 48px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 10;
        }

        /* Game Over overlay */
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 40px;
            border-radius: 10px;
            display: none;
            z-index: 20;
        }

        #gameOver h1 {
            margin: 0 0 20px 0;
            font-size: 64px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        #gameOver p {
            margin: 10px 0;
            font-size: 24px;
        }

        /* Instrukce při spuštění hry */
        #instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            font-size: 32px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 15;
            display: block;
        }
    </style>
</head>
<body>
    <!-- HUD pro zobrazení skóre -->
    <div id="hud">Skóre: 0</div>
    
    <!-- Instrukce při začátku hry -->
    <div id="instructions">Stiskni MEZERNÍK pro start!</div>
    
    <!-- Game Over screen -->
    <div id="gameOver">
        <h1>GAME OVER</h1>
        <p id="finalScore">Finální skóre: 0</p>
        <p>Stiskni MEZERNÍK pro restart</p>
    </div>

    <!-- Načtení Three.js z CDN -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    
    <script>
        // ==============================================
        // KONSTANTY A NASTAVENÍ HRY
        // ==============================================
        
        const GRAVITY = -0.0008;           // Gravitační konstanta působící na ptáka
        const JUMP_VELOCITY = 0.02;        // Rychlost skoku při stisknutí mezerníku
        const THRUST = 0.0012;             // Kontinuální tah při držení mezerníku
        const BIRD_SIZE = 0.5;             // Velikost ptáka (poloměr koule)
        const PIPE_WIDTH = 1;              // Šířka trubky (překážky)
        const PIPE_GAP = 3;                // Velikost mezery mezi horní a dolní trubkou
        const PIPE_SPEED = 0.03;           // Rychlost pohybu trubek doleva
        const PIPE_SPAWN_INTERVAL = 2000;  // Interval spawnu nových trubek (v ms)
        const WORLD_WIDTH = 20;            // Šířka herního světa
        const WORLD_HEIGHT = 15;           // Výška herního světa
        const GROUND_HEIGHT = 0.5;         // Výška země

        // ==============================================
        // HERNÍ PROMĚNNÉ
        // ==============================================
        
        let scene, camera, renderer;       // Základní Three.js objekty
        let bird;                          // Objekt představující ptáka
        let birdVelocity = 0;              // Vertikální rychlost ptáka
        let pipes = [];                    // Pole všech aktivních trubek
        let score = 0;                     // Aktuální skóre
    let bestScore = 0;                 // Nejlepší (uložený) skóre
        let gameStarted = false;           // Příznak, zda hra začala
        let gameOver = false;              // Příznak, zda hra skončila
        let lastPipeTime = 0;              // Čas posledního spawnu trubky
        let ground, ceiling;               // Objekty země a stropu
        let spacePressed = false;          // Příznak držení mezerníku

        // ==============================================
        // INICIALIZACE SCÉNY
        // ==============================================
        
        function init() {
            // Vytvoření scény - kontejner pro všechny 3D objekty
            scene = new THREE.Scene();
            // Použijeme průhledné pozadí rendereru, pozadí nastavíme přes CSS (fialový gradient)

            // Nastavení ortografické kamery pro 2D pohled
            // Ortografická kamera nemá perspektivu, objekty stejné velikosti
            // vypadají stejně velké nezávisle na vzdálenosti
            const aspect = window.innerWidth / window.innerHeight;
            const frustumSize = WORLD_HEIGHT;
            camera = new THREE.OrthographicCamera(
                frustumSize * aspect / -2,  // left
                frustumSize * aspect / 2,   // right
                frustumSize / 2,            // top
                frustumSize / -2,           // bottom
                0.1,                        // near
                1000                        // far
            );
            camera.position.z = 10;  // Posuneme kameru zpět, aby viděla scénu

            // Vytvoření rendereru - vykresluje scénu
            // Povolit alpha, aby bylo vidět CSS background za canvasem
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Vytvoření světel pro lepší vizuální vzhled
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.4);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            // Vytvoření ptáka
            createBird();

            // Vytvoření země a stropu
            createGroundAndCeiling();

            // Načteme nejlepší skóre a aktualizujeme HUD
            loadBestScore();
            updateScore();

            // Obsluha změny velikosti okna
            window.addEventListener('resize', onWindowResize);
            
            // Obsluha stisku a držení mezerníku
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
        }

        // ==============================================
        // VYTVOŘENÍ PTÁKA
        // ==============================================
        
        function createBird() {
            // Orange sphere jako tělo dýně
            const geometry = new THREE.SphereGeometry(BIRD_SIZE, 32, 32);
            const material = new THREE.MeshPhongMaterial({ 
                color: 0xFF8C00,  // Oranžová (pumpkin)
                shininess: 40 
            });
            bird = new THREE.Mesh(geometry, material);
            bird.position.set(-5, 0, 0);

            // Přidáme jednoduchou "tvář" dýně jako plane s texture z canvasu
            const faceTexture = createPumpkinFaceTexture();
            const faceMaterial = new THREE.MeshBasicMaterial({ map: faceTexture, transparent: true });
            const facePlane = new THREE.Mesh(new THREE.PlaneGeometry(BIRD_SIZE * 1.6, BIRD_SIZE * 1.6), faceMaterial);
            // Umístíme placku těsně před kouli, aby vypadala jako vyřezaná tvář
            facePlane.position.set(0, 0, BIRD_SIZE + 0.01);
            // Přidáme facePlane jako child do bird, takže se pohybuje s ním
            bird.add(facePlane);

            scene.add(bird);
        }

        // Vytvoří canvas texture s jednoduchou "pumpkin" tváří (oči, ústa)
        function createPumpkinFaceTexture() {
            const size = 256;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            // Transparentní pozadí
            ctx.clearRect(0, 0, size, size);

            // Oči (trojúhelníky)
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.moveTo(size * 0.33, size * 0.35);
            ctx.lineTo(size * 0.28, size * 0.45);
            ctx.lineTo(size * 0.38, size * 0.45);
            ctx.closePath();
            ctx.fill();

            ctx.beginPath();
            ctx.moveTo(size * 0.67, size * 0.35);
            ctx.lineTo(size * 0.62, size * 0.45);
            ctx.lineTo(size * 0.72, size * 0.45);
            ctx.closePath();
            ctx.fill();

            // Ústa (zubaté)
            ctx.beginPath();
            ctx.moveTo(size * 0.28, size * 0.62);
            ctx.lineTo(size * 0.72, size * 0.62);
            ctx.lineTo(size * 0.66, size * 0.72);
            ctx.lineTo(size * 0.60, size * 0.62);
            ctx.lineTo(size * 0.52, size * 0.72);
            ctx.lineTo(size * 0.44, size * 0.62);
            ctx.lineTo(size * 0.34, size * 0.72);
            ctx.closePath();
            ctx.fill();

            const texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;
            return texture;
        }

        // ==============================================
        // VYTVOŘENÍ ZEMĚ A STROPU
        // ==============================================
        
        function createGroundAndCeiling() {
            // Země - zelená deska na spodní straně
            const groundGeometry = new THREE.BoxGeometry(WORLD_WIDTH * 2, GROUND_HEIGHT, 1);
            const groundMaterial = new THREE.MeshPhongMaterial({ color: 0x00AA00 });
            ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.position.set(0, -WORLD_HEIGHT / 2 + GROUND_HEIGHT / 2, 0);
            scene.add(ground);

            // Strop - tmavě modrá deska na horní straně
            const ceilingGeometry = new THREE.BoxGeometry(WORLD_WIDTH * 2, GROUND_HEIGHT, 1);
            const ceilingMaterial = new THREE.MeshPhongMaterial({ color: 0x0066CC });
            ceiling = new THREE.Mesh(ceilingGeometry, ceilingMaterial);
            ceiling.position.set(0, WORLD_HEIGHT / 2 - GROUND_HEIGHT / 2, 0);
            scene.add(ceiling);
        }

        // ==============================================
        // VYTVOŘENÍ "KOSTI" (BONE) PRO PŘEKÁŽKY
        // ----------------------------------------------
        // Kost bude složena ze středového válce a dvou koulí na koncích,
        // tento tvar bude použit místo dřívějších boxů (trubek).
        function createBone(height) {
            const group = new THREE.Group();

            const radius = PIPE_WIDTH / 2;

            // Shaft (válec)
            const shaftGeometry = new THREE.CylinderGeometry(radius * 0.7, radius * 0.7, Math.max(0.1, height - radius * 2), 16);
            const boneMaterial = new THREE.MeshPhongMaterial({ color: 0xF5E9D3 }); // světlá "kost"
            const shaft = new THREE.Mesh(shaftGeometry, boneMaterial);
            // Cylinder je orientován podél osy Y — necháme ho uprostřed
            shaft.position.set(0, 0, 0);
            group.add(shaft);

            // Caps (konce jako koule)
            const capRadius = radius * 1.15;
            const capGeometry = new THREE.SphereGeometry(capRadius, 16, 16);
            const capTop = new THREE.Mesh(capGeometry, boneMaterial);
            const capBottom = new THREE.Mesh(capGeometry, boneMaterial);
            // Umístíme koule na konce válce
            const halfShaft = (Math.max(0.1, height - radius * 2)) / 2;
            capTop.position.set(0, halfShaft, 0);
            capBottom.position.set(0, -halfShaft, 0);
            group.add(capTop);
            group.add(capBottom);

            // Uložíme výšku do userData pro kolizní logiku
            group.userData = { height: height };

            return group;
        }

        // ==============================================
        // ULOŽENÍ / NAČTENÍ NEJLEPŠÍHO SKÓRE
        // Používáme localStorage s fallbackem do cookies
        // ==============================================
        function setCookie(name, value, days) {
            let expires = '';
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = '; expires=' + date.toUTCString();
            }
            document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/';
        }

        function getCookie(name) {
            const nameEQ = name + '=';
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
            }
            return null;
        }

        function loadBestScore() {
            try {
                const stored = localStorage.getItem('flappy_best');
                if (stored !== null) {
                    bestScore = parseInt(stored, 10) || 0;
                    return;
                }
            } catch (e) {
                // localStorage může být nedostupné - pokračujeme na cookies
            }

            // fallback do cookie
            const cookieVal = getCookie('flappy_best');
            if (cookieVal !== null) {
                bestScore = parseInt(cookieVal, 10) || 0;
            } else {
                bestScore = 0;
            }
        }

        function saveBestScore(value) {
            bestScore = value;
            try {
                localStorage.setItem('flappy_best', String(value));
            } catch (e) {
                // ignore localStorage errors
            }
            // vždy zapisujeme i cookie jako fallback (7 dní)
            setCookie('flappy_best', String(value), 7);
            // aktualizujeme HUD
            updateScore();
        }

        // ==============================================
        // VYTVOŘENÍ PŘEKÁŽKY (TRUBKY)
        // ==============================================
        
        function createPipe() {
            // Náhodná výška mezery - střed mezery je někde mezi -3 a 3
            const gapCenterY = Math.random() * 6 - 3;
            
            // Výška horní a dolní trubky
            const topPipeHeight = WORLD_HEIGHT / 2 - GROUND_HEIGHT - gapCenterY - PIPE_GAP / 2;
            const bottomPipeHeight = WORLD_HEIGHT / 2 - GROUND_HEIGHT + gapCenterY - PIPE_GAP / 2;

            // Vytvoření horní a dolní překážky jako "kosti"
            const topPipe = createBone(topPipeHeight);
            const bottomPipe = createBone(bottomPipeHeight);

            // Umístění horní a dolní překážky (střed skupiny je uprostřed)
            topPipe.position.set(
                WORLD_WIDTH / 2 + PIPE_WIDTH,  // Spawn napravo od obrazovky
                WORLD_HEIGHT / 2 - GROUND_HEIGHT - topPipeHeight / 2,
                0
            );

            bottomPipe.position.set(
                WORLD_WIDTH / 2 + PIPE_WIDTH,  // Spawn napravo od obrazovky
                -WORLD_HEIGHT / 2 + GROUND_HEIGHT + bottomPipeHeight / 2,
                0
            );

            scene.add(topPipe);
            scene.add(bottomPipe);

            // Uložení informace o trubce do pole
            pipes.push({
                top: topPipe,
                bottom: bottomPipe,
                scored: false
            });
        }

        // ==============================================
        // AKTUALIZACE PTÁKA
        // ==============================================
        
        function updateBird() {
            if (!gameStarted || gameOver) return;

            // Aplikace gravitace na rychlost ptáka
            birdVelocity += GRAVITY;

            // Pokud hráč drží mezerník, aplikujeme kontinuální tah/upwards thrust
            if (spacePressed) {
                birdVelocity += THRUST;
            }

            // Aktualizace pozice ptáka podle rychlosti
            bird.position.y += birdVelocity;

            // Rotace ptáka podle rychlosti (vizuální efekt)
            // Když pták stoupá, naklání se nahoru, když padá, naklání se dolů
            bird.rotation.z = birdVelocity * 3;
        }

        // ==============================================
        // AKTUALIZACE TRUBEK
        // ==============================================
        
        function updatePipes() {
            if (!gameStarted || gameOver) return;

            // Procházení všech trubek
            for (let i = pipes.length - 1; i >= 0; i--) {
                const pipe = pipes[i];

                // Posun trubek doleva
                pipe.top.position.x -= PIPE_SPEED;
                pipe.bottom.position.x -= PIPE_SPEED;

                // Kontrola, zda pták prošel mezerou (pro skóre)
                if (!pipe.scored && bird.position.x > pipe.top.position.x + PIPE_WIDTH / 2) {
                    score++;
                    pipe.scored = true;
                    updateScore();
                }

                // Odstranění trubek, které zmizely z obrazovky (vlevo)
                if (pipe.top.position.x < -WORLD_WIDTH / 2 - PIPE_WIDTH * 2) {
                    scene.remove(pipe.top);
                    scene.remove(pipe.bottom);
                    pipes.splice(i, 1);
                }
            }
        }

        // ==============================================
        // DETEKCE KOLIZÍ
        // ==============================================
        
        function checkCollisions() {
            if (!gameStarted || gameOver) return;

            // Hranice ptáka
            const birdTop = bird.position.y + BIRD_SIZE;
            const birdBottom = bird.position.y - BIRD_SIZE;
            const birdLeft = bird.position.x - BIRD_SIZE;
            const birdRight = bird.position.x + BIRD_SIZE;

            // Kolize se zemí
            if (birdBottom <= -WORLD_HEIGHT / 2 + GROUND_HEIGHT) {
                endGame();
                return;
            }

            // Kolize se stropem
            if (birdTop >= WORLD_HEIGHT / 2 - GROUND_HEIGHT) {
                endGame();
                return;
            }

            // Kontrola kolize s trubkami
            for (let pipe of pipes) {
                const pipeLeft = pipe.top.position.x - PIPE_WIDTH / 2;
                const pipeRight = pipe.top.position.x + PIPE_WIDTH / 2;

                // Kontrola, zda pták je horizontálně v oblasti trubky
                if (birdRight > pipeLeft && birdLeft < pipeRight) {
                    // Získání hranic mezery
                    // Pokud používáme bone group, výška je uložena v userData.height
                    const topHeight = pipe.top.userData && pipe.top.userData.height ? pipe.top.userData.height : (pipe.top.geometry && pipe.top.geometry.parameters ? pipe.top.geometry.parameters.height : 0);
                    const bottomHeight = pipe.bottom.userData && pipe.bottom.userData.height ? pipe.bottom.userData.height : (pipe.bottom.geometry && pipe.bottom.geometry.parameters ? pipe.bottom.geometry.parameters.height : 0);

                    const topPipeBottom = pipe.top.position.y - topHeight / 2;
                    const bottomPipeTop = pipe.bottom.position.y + bottomHeight / 2;

                    // Kontrola, zda pták narazil do horní nebo dolní trubky
                    if (birdTop > topPipeBottom || birdBottom < bottomPipeTop) {
                        endGame();
                        return;
                    }
                }
            }
        }

        // ==============================================
        // SPAWN NOVÝCH TRUBEK
        // ==============================================
        
        function spawnPipes(currentTime) {
            if (!gameStarted || gameOver) return;

            // Kontrola, zda uplynul dostatečný čas od posledního spawnu
            if (currentTime - lastPipeTime > PIPE_SPAWN_INTERVAL) {
                createPipe();
                lastPipeTime = currentTime;
            }
        }

        // ==============================================
        // OBSLUHA STISKU KLÁVESY
        // ==============================================
        
        // Nová obsluha pro keydown: první stisk spustí start/restart/skok, držení nastaví spacePressed
        function onKeyDown(event) {
            if (event.code === 'Space' || event.keyCode === 32) {
                event.preventDefault();

                // Pokud to je první detekce keydown (ne auto-repeat), proveď akci
                if (!spacePressed) {
                    if (!gameStarted) {
                        startGame();
                    } else if (gameOver) {
                        restartGame();
                    } else {
                        // Původní skok na stisknutí
                        jump();
                    }
                }

                // Označíme, že mezerník je podržen
                spacePressed = true;
            }
        }

        // Když uživatel pustí mezerník, zastavíme kontinuální tah
        function onKeyUp(event) {
            if (event.code === 'Space' || event.keyCode === 32) {
                event.preventDefault();
                spacePressed = false;
            }
        }

        // ==============================================
        // SKOK PTÁKA
        // ==============================================
        
        function jump() {
            // Nastavení vertikální rychlosti nahoru
            birdVelocity = JUMP_VELOCITY;
        }

        // ==============================================
        // START HRY
        // ==============================================
        
        function startGame() {
            gameStarted = true;
            lastPipeTime = Date.now();
            document.getElementById('instructions').style.display = 'none';
            
            // První skok při startu
            jump();
        }

        // ==============================================
        // UKONČENÍ HRY
        // ==============================================
        
        function endGame() {
            gameOver = true;
            
            // Zobrazení Game Over obrazovky
            // Pokud máme nový rekord, uložíme ho
            if (score > bestScore) {
                saveBestScore(score);
                document.getElementById('finalScore').textContent = `Finální skóre: ${score} — NOVÝ REKORD!`;
            } else {
                document.getElementById('finalScore').textContent = `Finální skóre: ${score}`;
            }
            document.getElementById('gameOver').style.display = 'block';
        }

        // ==============================================
        // RESTART HRY
        // ==============================================
        
        function restartGame() {
            // Reset všech herních proměnných
            gameOver = false;
            gameStarted = false;
            score = 0;
            birdVelocity = 0;

            // Reset pozice ptáka
            bird.position.set(-5, 0, 0);
            bird.rotation.z = 0;

            // Odstranění všech trubek
            for (let pipe of pipes) {
                scene.remove(pipe.top);
                scene.remove(pipe.bottom);
            }
            pipes = [];

            // Aktualizace UI
            updateScore();
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('instructions').style.display = 'block';
        }

        // ==============================================
        // AKTUALIZACE SKÓRE V HUD
        // ==============================================
        
        function updateScore() {
            // Zobrazíme aktuální skóre a nejlepší skóre vedle něj
            document.getElementById('hud').textContent = `Skóre: ${score} • Rekord: ${bestScore}`;
        }

        // ==============================================
        // OBSLUHA ZMĚNY VELIKOSTI OKNA
        // ==============================================
        
        function onWindowResize() {
            // Přepočítání aspect ratio
            const aspect = window.innerWidth / window.innerHeight;
            
            // Aktualizace kamery
            camera.left = -WORLD_HEIGHT * aspect / 2;
            camera.right = WORLD_HEIGHT * aspect / 2;
            camera.top = WORLD_HEIGHT / 2;
            camera.bottom = -WORLD_HEIGHT / 2;
            camera.updateProjectionMatrix();

            // Aktualizace velikosti rendereru
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ==============================================
        // HLAVNÍ HERNÍ SMYČKA
        // ==============================================
        
        function animate() {
            // requestAnimationFrame zajišťuje plynulé vykreslování (~60 FPS)
            requestAnimationFrame(animate);

            // Aktualizace herních objektů
            updateBird();
            updatePipes();
            checkCollisions();
            spawnPipes(Date.now());

            // Vykreslení scény
            renderer.render(scene, camera);
        }

        // ==============================================
        // SPUŠTĚNÍ HRY
        // ==============================================
        
        // Inicializace při načtení stránky
        init();
        
        // Spuštění herní smyčky
        animate();
    </script>
</body>
</html>
